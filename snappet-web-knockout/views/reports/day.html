

<div class="left-menu">
  <select class="form-control" data-bind="options: dates" onchange="loadDate();" id="dateSelector"></select>
  <ul data-bind="foreach: data" class="actionItem">
    <li data-bind="text: LearningObjective, click: loadDataView.bind($data, LearningObjectiveID)"></li>
  </ul>
</div>
<div class="page-content">
  <div class="topMargin">
    <h3 class="page-title" data-bind="if: modalData().LearningObjective">Learning Objective: <span data-bind="text: modalData().LearningObjective"></span></h3>
    <h3 class="page-title" data-bind="if: !modalData().LearningObjective">Select a date and learning objective to view available data</h3>
    <div class="row">
      <div class="col-md-3">
        <ul data-bind="foreach: modalData().Exercises" class="actionItem exercise-list" id="exerciseList" style="max-height: 600px">
          <li>
            <span data-bind="text: ExerciseID, attr: {'id': 'exc_' + ExerciseID}, click: loadGraphView.bind($data, ExerciseID)"> </span>
          </li>
        </ul>
      </div>
      <div class="col-md-9">
        <canvas id="graphView"></canvas>
        <div data-bind="if: modalData().LearningObjective">
          <p>Exercise ID: <span data-bind="text: exerciseData().ExerciseID"></span></p>
          <p>Exercise Difficulty: <span data-bind="text: exerciseData().Difficulty"></span></p>
          <p>Answered by: <span data-bind="text: userList().length"></span> people</p>
          <ul data-bind="foreach: userList()" class="actionItem answered-users">
            <li>
              <span data-bind="text: UserID, click: loadUser.bind($data, UserID)"> </span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
  var baseURL = "http://localhost:62058/api";
  var tempL;
  function PageModel() {
    var self = this;

    self.dates = ko.observable([]);
    self.data = ko.observable([]);
    self.modalData = ko.observable({});
    self.exerciseData = ko.observable({});
    self.userList = ko.observable({});

    loadDataView = function (data) {
      var full = window.vm.data();

      var res = $.grep(full, function (e) { return e.LearningObjectiveID == data; })[0];
      tempL = res;
      window.vm.modalData(res);
      loadGraphView(res.Exercises[0].ExerciseID);
    }

    loadGraphView = function (exerciseID) {
      $("#exerciseList >li >span.active").removeClass("active");
      $("#exc_" + exerciseID).addClass("active");
      var res = $.grep(tempL.Exercises, function (e) { return e.ExerciseID == exerciseID; })[0];
      window.vm.exerciseData(res);

      var list = [];
      for (var i = 0; i < res.UserAnswers.length; i++) {
        if (list.findIndex(p => p.UserID == res.UserAnswers[i].UserID) < 0) {
          list.push({
            UserID: res.UserAnswers[i].UserID
          });
        }
      }

      loadUser = function (userID) {
        window.location = "#/Students/" + userID;
      }

      window.vm.userList(list);
      var gData = {
        Correct: 0,
        Incorrect: 0
      }

      for (var i = 0; i < res.UserAnswers.length; i++) {
        if (res.UserAnswers[i]["Correct"]) {
          gData.Correct++;
        } else {
          gData.Incorrect++;
        }
      }
      console.log(gData);
      makeGraph(gData);
    }
  }


  window.vm = new PageModel();
  ko.applyBindings(vm);

  $.getJSON(baseURL + "/reports/GetAvailableDates",
    function (result) {
      window.vm.dates(result);
    });


  function loadDate() {
    $.getJSON(baseURL + "/reports/ClassReport?date=" + $("#dateSelector").val(),
      function (result) {
        console.log(result);
        window.vm.data(result);
      });
  }
  var ctx = document.getElementById("graphView").getContext('2d');
  var myChart = new Chart(ctx, null);
  function makeGraph(_data) {
    myChart.destroy();
    myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ["Correct", "Incorrect"],
        datasets: [{
          label: '# of Correct Answers',
          data: [_data.Correct, _data.Incorrect],
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)'
          ],
          borderColor: [
            'rgba(255,99,132,1)',
            'rgba(54, 162, 235, 1)',
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });
  }


</script>